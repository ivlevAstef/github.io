---
layout: default
---

И так... ой как я люблю это слово сочетание :D
Тут я опишу свой коммерческий опыт.

Про то, как я поливал цветочки около университета, я писал [тут](./index.html). А тут будет описаны все мои места работы, плюсы и минусы, причины ухода, и что я вынес из этого опыта.

И начнем мы чуть из далека - стажировка. Я по сей день не знаю считать это коммерческим опытом или нет, но деньги за это платили, и относительно не плохие.

# Стажировка в parallels

На самом деле по чесному это было отдельно подразделение, при [parallels](https://ru.wikipedia.org/wiki/Parallels), а не прям эта компания. Мы в этом подразделении игры делали. Как это было связано с этой компанией, я по сей день не знаю, но как-то было.

На самом деле игры были не совсем обычные - в них в обязательном порядке присутствовал какой-то раздел математики/физики, в достаточно углубленном виде. Я попал наверное на самую веселую игру - nanofootball. Суть игры простая - объедините чапаев с футболом, и получится nanofootball. То есть это пошаговая игра (но легко могла быть и реалтайм), где надо толкать свои фишки, чтобы забить специальную фишку мяч, в ворота противника. Чем-то напоминает еще аэрохокей, но только в который одновременно играю по 5 игрок с каждой стороны. Какая была математику в этой игре? В ней была реализована полноценная 2д физика, в которой фишки могли закручиваться, и двигаться соответственно не по прямой траектории. Не то чтобы прям нереализуемая задача, но в те времена физические движки обычно плохо еще справлялись с этой задачей в реальном времени. Тем более в игре были достаточно большие скорости.

Я попал в проект, когда он уже имел основной функционал - физика уже была, фишки можно было бить, геймплей какой-то да был. Первой моей задаче было - добавить магию. Не моя идея, ничего не знаю. Хотелось как-то разнообразить игру команде :) Какая была магия? Заморозка, ускорение, замедление, поставить стенку на поле, и что-то еще. Помню что было 5 видов, но забыл что было пятое. Это была моя первая задача, поэтому пришлось еще изучить и проект. Справился я помойму где-то за месяц с этой задачей, хотя по мере развития проекта, что-то там еще дорабатывалось. 

После этой задачи пошли уже всякие рутиные дела - рисовали меню, делали мультиплеер, улучшать код и т.п. Но была задача которую я вызвался сам делать. Щас расскажу немного за архитектуру :) Был в этом проекте один заголовочный файл, с названием не помню каким, суть которого была следующая - он подключал почти все заголовочные файлы проекта. Ах да язык С++, заголовочный файл это файл с расширение .h/.hpp в котором обычно описывается информация о классе, без её реализации. И я увидев это, загорелся желанием убрать столь ужасное решение. То, что это плохо согласились все, но как говорится идеи должны быть наказуемы - исправлять проблему пришлось одному.
Потребовало это уйму времени, в добавок пришлось еще по дороге разделять некоторые файлы на части, и решать циклические зависимости. Но результат стоил того.

Как часто вы можете назвать свои достижения в цифрах? Вот в данном случае я могу. Время сборки проекта с 10-11минут уменьшилось до 2-2.5минут. То есть сборка ускорилась в 4-5 раз с нуля. Про инкрементальную вообще молчу - очевидно, что до этого такого понятия можно считать не существовало - ибо проект почти всегда пересобирался целиком. После такого изменения инкрементальная сборка стала работать как надо.

Также я в проекте неплохо так оптимизировал дубликацию кода, и объединение похожих участков в функции/классы. Но не помню уже численные показатели сего изменения. Конечно я и добавил фич: магия, сетевая игра, обновленное меню.

Думаю у многих возникло ощущение, что это было на последних курсах университета, и проработал я там больше года. Но это не так. Это было после первого курса университета, С++ я учил самостоятельно во время первого курса, и проработал я всеголишь пол.года. Причина ухода была простой - почти все ушли, и стало скучно. Как оказалось, мало кто способен сочетать учебу и подработку.

Что я вынес с этой работы? Это был первый опыт работы с более/менее средним проектом, опыт работы в команде, с С++. И я оценил насколько архитектура влияет на сборку. 

Кто-то скажет - ну у нас языки современные, там нет деления на hpp/cpp файлы, и всё это не важно. Спешу огорчить - проблемы теже самые, просто многое скрыто под коробкой, и не всегда можно очевидно сказать, что от чего зависимо.

# Появление своей компании, или зимняя школа программирования

Летом после второго курса судьба не сложилась, и я никуда не пошел работать. Но зато зимой я наверстал упущенное с лихвой.

И так 3 курс, закончился первый семестр, экзамены. Один экзамен я уже не сдал, под полное счастье не сдал даже на пересдачи, и пришлось идти брать повторную пересдачу. Забегая вперед, на повторной пересдачи я сдал на  его на 4. Но не это важное. Важно другое - зная, что мне надо готовиться к повторке, один из моих однокурсников/друзей, мне предлагает - там зимняя школа программирования начинается, не хочешь сходить? Я немного поломавшись, сказал Да, и считаю, что это было самым верным решением.

На зимней школе программирования был выбор чем заниматься, мы с другом решили пойти в мобильную секцию. Там учили языку Obj-C под iOS, и надо было за 2 или 3 недели сделать свою игрушку в команде. По началу мы были в команде из 5 человек, и делали некоторое подобие арканоида. Но в первую же неделю, мы не смогли определится как будет выглядеть игра, и команда развалилась. Мы с другом начали делать своё, а остальные три человека своё.

Игра получило название "вандал" и суть была её следующая - человечек внизу экрана стоит с рогадкой, и стреляя из нее сбивает разные предметы находящиеся на полках. Игра была с физикой, но на тот момент были еще без веревок. Под конец зимней школы, друг привлек свою девушку, и она нам нарисовала хоть какие-то картинки под это всё. Код при этом к игре писал я почти один, а друг тем временем занимался продажей души дьяволу... Ну точнее это дьявол ему душу по итогу продал.

В общем пока я в одного делал игру, которая конечно же выиграла среди конкурса проектов внутри школы, мой друг в одного сумел найти нам продюсера и инвестора в одном лице. Это был один из менеджеров компании [Alawar](https://www.alawar.ru/) и на тот момент компания пробовал новый формат - внешние студии разработки.

Дальше все завертелось закрутилось, и в итоге появилась компания Grizzly-jr, со следующим штатом:
- Мой друг как директор, человек по документам, и договорам, ну и частично геймдизайнер.
- Я как программист, и тоже частично геймдизайнер.
- Девушка друга, как помошник нам с картинками. Позже она бросила основную работу, и стала рисовать картинки на постоянке.
- Alawar - наш продюсер, и инвестор. С ними у нас был заключен договор, вида "они нам ЗП, и выпуск, мы им доходы от продаж - причем первую часть денег 100% им"

# Grizzly-jr (2.5 года, C++/Obj-C, iOS)

Вот с этого момента я считаю это коммерческим опытом. 

## Robber Rabbits

Первая наша игра была [Robber Rabbits](https://www.youtube.com/watch?v=qHjqc9IIje8) - по сути это был переработанные и улучшенный "вандал". О самой игре можно почитать в интернете, несмотря на возраст, данных об игре сохранилось достаточно много.

Первую версию мы делали 3-4 месяца. Она включала в себя три магазина (три локации), на каждой по 24 уровня. В прочем это можно и так найти. Давайте к разработке.
Основные сложности/задачи в игре были следующие:

1. Сделать веревки. Посмотрите видео, и оцените какие они классные. Если вы думаете, что это простая задача, то почитайте вначале [это](https://habr.com/ru/post/135338/). В статье все "просто", по факту человек не разобрался с темой - он сделал упрощенную версию, и решил, что между 80% и 100% разница не столь велика. Во первых кривая безье ведет себя не так как нужно. Поэтому и у нас и у Cut the Rope, это скажем так модифицированная кривая безье - принцип тотже, но не более. Во вторых в статье человек воспользовался antialias, которого мы себе позволить не могли. По факту каждый сегмент веревки это 6 маленьких треугольников. 2 Треугольника - центр веревки, и по 2 треугольника используется для сглаживания - так-как треугольники OpenGL умеет рисовать с прозрачными вершинами, и с плавным переходом. Понятное дело, все эти треугольники надо еще правильно соединять - это всеже не просто кривая из N точек. Если кривая гнется, то треугольники внутри радиуса сокращаются, а снаружи растягиваются. При этом при сокращении не должно возникнуть случайно "отрицательных" координат. Еще в статье не упоминается производительность. Мы у себя старались не делать длинных веревок (но есть уровни и с длинными), а вот у Cut the rope я думаю это была одна из важнейших задач. Но могу сказать так - количество звений в физическом мире делалось сильно меньше, чем можно себе увидеть при визуализации. Просто при визуализации, добавлялись "виртуальные" звенья.
2. Редактор уровней и предметов (ведь они тоже разной формы/весом/упрогостью). Он был написан на Java. Чесно скажу - это была плохая идея делить редактор и игру. В будущих играх мы это учли. Но зато он был быстро написан, но пользоваться было не очень удобно: приходилось сохранять уровень, скидывать на телефон, и смотреть в игре как же оно себя ведет.
3. Интеграция/Ачивки. Что же в этом сложного? Ну первый раз все сложно :) А так ачивки, это не прям то что лежит на поверхности. Ну например ачивка на подобии "сделать 10 выстрелов из ружья на N уровне" - подобная ачивка означает необходимость вести счетчик, проверять уровень, проверять тип оружия и т.д. В общем для ачивок, была сделана отдельная подсистема, где все события записывались, и потом анализировались. Это позволило создавать ачивки гибко, и быстро.
4. Телепорт. Ух... Вы не представляете как сложно в физическом мире переместить предмет из одной точки в другую, с сохранение инерции, но с возможной сменой направления. По итогу предмет удаляется в физическом мире, у него сохраняются все основные его характеристики, и потом создается в другом месте, а характеристики нельзя просто присвоить (скажем спасибо Box2d), поэтому чтобы присвоить характеристики, надо было научится "бить" по предмету, чтобы он получил импульс эквивалентный прошлому.
5. Загрузка сцен. Это щас нам можно куча картинок загрузить в память, так что пользователь даже не заметит. Но не тогда. Во первых было ограничение на размер занимаемой памяти при 60мб apple с 80% вероятностью выгружал приложение из памяти. Ну и чем больше, тем шанс выше. В идеале не занимать больше 50мб. Поэтому загрузить все картинки которые есть в игре сразу в память не представлялось возможным. Конечно проблему можно было решить сделав графику по проще/меньше, но мы не ищем легких путей. Поэтой самой причине, мы загружаем и выгружаем набор картинок при переходе со сцены на сцену, чтобы вписываться в 50-60мб. Но так-как этот процесс занимает 2-3 секунды, то появились "шторки". Посмотрите видео. Там видно как по нажатию на кнопку вначале закрываются, а потом открываются зеленые шторки. Они нужны были, чтобы замаскировать момент смены ресурсов. Так пользователь думает, что это просто анимация, а не то, что там происходят тяжелые дейтсвия под капотом.

Конечно по мере развития игры, появлялись новые игровые предметы. Например последний был "осы" - они вылетали из улья, и летели за главным предметом "морковным мороженным". И их надо было сделать умными. При этом не сильно умными, достаточно предсказуемыми, и желательно, чтобы они не тратили много времени на поиск пути. Алгоритм у них конечно движения простой по итогу - лететь к мороженному по прямой, а если они ударились, то лететь или со смещение вправо или со смещение влево. Сами осы еще при рождении были правые и левые :) Конечно лететь "вправо"/"влево" это легко звучит, а по факту чуть сложнее так-как есть гравитация, предметы могут быть накланены, но сути это сильно не меняет.

Игра получилась хорошей, мы смогли получить более миллиона скачиваний, даже без большой рекламы со стороны Alawar. Под счастье нас зафичирил Apple, и это сильно помогло. Но игру постигла тяжелая судьба. Тот случай, когда лучше бы и не рекламировали. Alawar во франции решил прорекламировать игру, и сделал стенд с нашей игрой. К большому сожалению, кто-то зачем-то упомянул ubisoft на этом стенде. А у ubisoft тоже есть белые кролики из игры rayman. В общем ubisoft об этом прознали, и подали в суд. Apple сразу удалил игру из AppStore, а Alawar сдалось сразу - в прочем оно и понятно, размер фирм очень разный, не в пользу Alawar.

Итог права на игру отдали по итогу полностью нам (до этого по договору, права принадлежали Alawar), так-как чесно признали это их косяком. К сожалению, мы так и не перевыпустили игру с названием RobberBears с чудесной историей, как же кролики стали мишками, и кто им обрезал уши :)

## Cute Heroes

Это на самом деле не следующая наша игра, но следующая игра которая вышла в AppStore. Называлась она [Cute Heroes](https://megaobzor.com/Cute-Heroes---velikolepnaya-strategiya-na-iOS.html) и несмотря на то, что она вышла на два года позже первой, по ней информации в разы меньше. Игра не получила своей славы, хотя и бесспорно в нее играли. 

Как я считаю основная причина её провала, была в том, что после утверждения геймплея и разработки игры на 50-60%, у нее 3 раза этот самый геймплей менялся. В итоге несмотря на очень много шикарных технических решений, хорошую картинку, и даже стабильность после хотфикса (первая версия, крашилась из-за алгоритмов шифрования данных, и пришлось в срочном порядке это править), геймплей получился не сбалансированный. Вещи дающие какие-то плюки были несуразные, сами войска (особенно те, что открывались в самом конце) были плохо сбалансированные. В добавок сетевая игра 1на1 тоже частенько глючила.

Но если бы геймплей был бы согласован сразу быстрее, или после самой последней идеи геймплея, нас бы не поджимали со всех сторон по срокам, думаю игра бы получилась в разы более удачной. Потому-что даже с плохим балансом, я и знакомые могли в неё зависать на долго. Не ради прогресса, а ради картинки и наблюдением за юнитами - то как юниты сами бегали, выбирали цель, и как это всё анимировалось было чудесно. 


# Пока не дописал, но будет дописана вся история :)