---
layout: default
---

# Voice Processing на iOS, или сказ как паравозик не смог...

## Вступление

Я тут пару недель уже ничего не писал. Благо блог еще не рекламировал, поэтому оправдаваться не перед кем :)

А занимался я последних пару недель тем, что не выпускал релиз... В силу нехватки людей в QA отделе, в большинстве своём тестируют у нас приложение только перед выпуском, а заранее максимум проверяют только непосредственно новую задачу/баг, и не сильно тщательно. Поэтому если есть серьезные баги, то чаще всего выскакивают они перед релизом.

Под счастье пишу я код редко с багами, и релизы выпускаются нормально, но в этот раз всё пошло полность на перекосяк, всего из-за одной строчки.

## Что нужно было сделать

В какой-то момент поступил баг, что есть эхо, при full duplex общении (это когда и говоришь и слушаешь одновременно). На андройд уже давно сделан echo canceller с automatic gain control (автоматически регулирует громкость) и noise suppressing. Сделано штатными средствами системы. Да там есть нюансы, что оно работает не на всех устройствах, но там где работает, там оно работает как надо.

## Завязка

Соответственно по подобию андройд, на iOS было решение воспользоваться чем-то похожим, в добавок при общении с Apple, они порекомендовали нам вот такую чтуку: [setvoiceprocessingenabled](https://developer.apple.com/documentation/avfaudio/avaudioionode/3152100-setvoiceprocessingenabled). Можете заценить подробную супер документацию о нем. Ну ладно, ладно есть еще [sample](https://developer.apple.com/documentation/avfaudio/audio_engine/using_voice_processing).

Месяца 3 назад, я уже пробовал его использовать, но у меня после 5-10 попыток крашилась аудио система, и я забил.

На этот раз решил подойти основательно, скачал sample, разобрался в нем, оценил его "стабильность". У Apple настолько шикарная система, что если в sample просто поставить с `true` на `false` значение этого флага, то sample крашится... Или если попробовать поменять строчки местами, то тоже крашится... 

Но ладно, когда нас останавливали sample в которых ничего нельзя менять? Повторил я пример из sample, смог в своей более сложной системе даже сделать возможность и включать и отключать voice processing, во время исполнения программы.

И вроде бы все хорошо, но... Меня еще в самом начале насторожил sample тем, что на iphone SE он работал близко к понятию идеально, а на iphone 12pro качество его работы оставляло желать лучшего. В тот момент я уже понял, что у apple voice processing какой-то неадекватный - он настолько старается убрать шумы, что может резать голос, но шум всеравно иногда да проскакивает.

Тоже самое произошло и на реальном коде...

## Действие

Итог включенной этой системы:

- iphone SE - работает идеально.
- iphone 12pro - микрофон становится нереально чувствительным, что даже если выкрутить на втором телефоне громкость почти в ноль, то можно всеравно оглохнуть. В добавок, всегда идут шумы.
- iphone 8plus - иногда при циклическом проигрывании обычного звука из файла, аудио система прерывает цикл на середине, и начинает его с начала, и так может сделать несколько раз подряд. При этом это все происходит без каких либо каллбэков/ошибок - программа об этом даже узнать не может.
- iphone xr - эхо подавление не просто не работает, оно усиливает эхо в разы...

В общем ужас ужасом, а если еще и AGC (Automatic Gain Control) включать/выключать, то такой зоопарк артефактов... Такое ощущение, что apple забили на эту функцию, и просто не настраивали под новые телефоны - а качество эхо подавление зависит от расстояния между вход/выход и чувствительностью/силе микрофона/динамиков. В общем параметры нужно подгонять под разные телефоны, ну или алгоритмы должны быть очень умные.

Под полное счастье выясняется, что у нас начинает звук сильно отставать - накапливается задержка при долгом разговоре. Где-то одна секунда за минуту. В ходе разбирательств выходит, что AVAudioSinkNode и AVAudioPlayerNode.scheduleBuffer оказывается захватывают/проигрывают данные дольше чем нужно. На примере:

- AVAudioSinkNode по умолчанию раз в N миллисекунд выдает M фреймов. По хорошему за 1 секунду должно суммарно получаться фреймов столько, сколько указано в sample rate, и если voice processing отключен, то это так и есть. Но если его включить, то происходит так, что M фреймов выдается не в `N ms`, а где-то в `1.15*N ms`. Да при эхо подавлении должна быть задержка, но она должна быть "константной" - то есть первый фрейм должен выдаться чуть позже чем без него, но каждый пакет фреймов задерживается на 15% это же жесть.
- AVAudioPlayerNode.scheduleBuffer тут оказалось тоже самое - закидываешь ему данных на `N ms`, а они их проигрывает по времени `1.15*N ms`

Как итог накапливание задержки. Это выясняется перед первым релизом - обычно длительные звонки не тестируются, так-как PTT разговоры чаще всего короткие. И full duplex без причины не проверяется.

Первое поправить как оказалось можно - использовать installTap метод. У него есть своя большая проблема конечно... он выдает данные не чаще чем раз в 100ms, а у нас внутри сетевого общения установлен интервал в 60ms. Но ничего - просто накапливает немного буффер вначале, и потом начинаем слать данные. В общем с микрофоном проблему решили, а о том, что и проигрывание тоже имеет задержку, на тот момент я не знал, это выяснилось попозже.

## Развязка

Первая дата релиза была успешно зафейлена, и релиз перенесли на неделю. За это время я поправил некоторые известные баги. Конечно работа voice processing мне не нравилась, но так-как это опция, было решено, что да какая разница - те кому нужно включат его, и возможно им повезет и телефон у них будет с ним работать хорошо. Тем более у заказчиков чаще всего старые модели телефонов.

Но когда через неделю начали проверять снова, было обнаружено, что приложение просто падает или не передает звук при использовании внешних Bluetooth устройств (гарнитур). Причину я понял даже не дебажа, в дебаге она подтвердилась - виноват был installTap - ну а если точнее совместимость форматов - с этим я уже сталкивался. Но когда я явно прописал форматы для проверки, причем пробовал я разные варианты: и формат устройства, и формат по умолчанию, и в разных комбинациях... то выяснилось, что при всем своем желание installTap не хочет работать при использовании гарнитур, и просто выдает пустой звук.

## Концовка

В общем вторая попытка релиза была зафейлина. Заново переносить релиз решили что не будем, и уже выпустимся вместе со следующей версий.

А по voice processing, я сказал, что больше не готов пробовать его использовать - если нам на самом деле нужно эхо подавление, да еще и в ситуациях когда два телефона лежат рядом (тут voice processing плохо работает), то идеально делать самому на сервере (ну или библиотекой), ну или можно на устройстве, но без использования apple штук, а самому обрабатывать сырые данные по звуку, и изменять их.

Тем более, что жалуется только один заказчик - у них много людей находятся в одном помещении, и из-за этого много лишнего шума.

Но одно изменение было всеравно сделано - в приложении добавлена возможность менять чувствительность микрофона, что на самом деле тоже может помочь.

## Как итоги

Ну во первых apple !@#$ ну вы и сами знаете :D

Во вторых если кто-то знает как же запустить этот voice processing чтобы работал на любом устройстве, расчитал для реалтайм передачи, и способен на работу с гарнитурой, то буду рад за рекомендаци.

В третьих - я не справился, признал ошибку, и жалею о потраченном времени... За потраченное время, можно было уже собственный приемлимый echo canceller написать...

Ну и это из серии, почему я не люблю библиотеки, особенно закрытые. Да потому-что вот так. Казалось бы - одна строчка, и все должно быть круто, но по факту куча убитого времени, нервов, и отсутствие результата.

P.S. Понятное дело, в перерывах пока я "всё" исправил и перепроверкой, я разрабатывал другой функционал, и сам проверял. Но проверял не сильно тщательно, в добавок проверять звук когда ты один, не так легко - приходится вечно включать записи на ютуб, уходить подальше с другим устройством и т.п. Да и представить себе не мог, что один Bool флаг, может приводить к стольким проблемам...